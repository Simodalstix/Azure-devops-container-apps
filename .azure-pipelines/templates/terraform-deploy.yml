# Terraform Deploy Template - Built-in bash commands
parameters:
- name: environment
  type: string
- name: serviceConnection
  type: string

steps:
- checkout: self

- task: Bash@3
  displayName: 'Install Terraform'
  inputs:
    targetType: 'inline'
    script: |
      wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
      echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
      sudo apt update && sudo apt install terraform
      terraform --version

- task: AzureCLI@2
  displayName: 'Terraform Init, Plan & Apply'
  inputs:
    azureSubscription: '${{ parameters.serviceConnection }}'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    workingDirectory: '$(System.DefaultWorkingDirectory)/infra/envs/${{ parameters.environment }}'
    inlineScript: |
      terraform init
      terraform plan -var-file="terraform.tfvars" -out=tfplan
      terraform apply tfplan